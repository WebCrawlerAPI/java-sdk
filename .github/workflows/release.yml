name: Release on Semver Tag

on:
  push:
    tags:
      # Match semver tags without 'v' prefix: 1.0.0, 1.2.3, 2.0.0-beta.1, etc.
      - '[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Display version
        run: |
          echo "Building release for version: ${{ steps.get_version.outputs.VERSION }}"

      - name: Run unit tests
        run: |
          cd tests
          chmod +x run-tests.sh
          ./run-tests.sh

      - name: Run integration tests
        if: ${{ secrets.API_KEY != '' }}
        env:
          API_KEY: ${{ secrets.API_KEY }}
          API_BASE_URL: https://api.webcrawlerapi.com
        run: |
          cd tests
          ./run-tests.sh

  build:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Compile SDK
        run: |
          mkdir -p build/classes
          javac -d build/classes WebCrawlerAPI.java

      - name: Create JAR
        run: |
          cd build/classes
          jar cf ../webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar *.class
          cd ../..

      - name: Create source ZIP
        run: |
          mkdir -p build/dist
          zip -r build/webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}-src.zip \
            WebCrawlerAPI.java \
            README.md \
            QUICKSTART.md \
            SUMMARY.md \
            example/ \
            tests/ \
            .github/ \
            -x "*/bin/*" "*.class"

      - name: Generate checksums
        run: |
          cd build
          sha256sum webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar > webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar.sha256
          sha256sum webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}-src.zip > webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}-src.zip.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            build/*.jar
            build/*.zip
            build/*.sha256

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: build

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "Extracting changelog for version $VERSION"

          # Create release notes
          cat > release_notes.md << 'EOF'
          # WebCrawlerAPI Standalone Java SDK ${{ steps.get_version.outputs.VERSION }}

          A simple, dependency-free Java client for WebCrawlerAPI.

          ## Features

          - âœ… Zero dependencies
          - âœ… Java 17+ compatible (tested on Java 8+)
          - âœ… Complete API coverage: `crawl()`, `scrape()`, `scrapeAsync()`
          - âœ… 50+ unit tests, all passing
          - âœ… Integration tests included

          ## Quick Start

          ### Option 1: Copy Single File

          ```java
          // Just copy WebCrawlerAPI.java into your project
          WebCrawlerAPI client = new WebCrawlerAPI("your-api-key");
          WebCrawlerAPI.ScrapeResult result = client.scrape("https://example.com", "markdown");
          System.out.println(result.content);
          ```

          ### Option 2: Use JAR

          ```bash
          # Download the JAR
          wget https://github.com/YOUR_ORG/YOUR_REPO/releases/download/${{ steps.get_version.outputs.VERSION }}/webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar

          # Compile with JAR
          javac -cp webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar YourApp.java

          # Run with JAR
          java -cp webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar:. YourApp
          ```

          ## Downloads

          - **JAR**: Compiled classes ready to use
          - **Source ZIP**: Complete source code with examples and tests
          - **SHA256**: Checksums for verification

          ## Documentation

          - [README](https://github.com/YOUR_ORG/YOUR_REPO/blob/${{ steps.get_version.outputs.VERSION }}/sdk/java/standalone-sdk/README.md)
          - [Quick Start Guide](https://github.com/YOUR_ORG/YOUR_REPO/blob/${{ steps.get_version.outputs.VERSION }}/sdk/java/standalone-sdk/QUICKSTART.md)
          - [Test Documentation](https://github.com/YOUR_ORG/YOUR_REPO/blob/${{ steps.get_version.outputs.VERSION }}/sdk/java/standalone-sdk/tests/README.md)

          ## Verification

          Verify checksums:
          ```bash
          sha256sum -c webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar.sha256
          sha256sum -c webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}-src.zip.sha256
          ```

          ---

          For issues or questions, visit: https://github.com/webcrawlerapi/webcrawlerapi
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
          files: |
            build/webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar
            build/webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}.jar.sha256
            build/webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}-src.zip
            build/webcrawlerapi-standalone-${{ steps.get_version.outputs.VERSION }}-src.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: release
    if: success()

    steps:
      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Release Summary
        run: |
          echo "âœ… Successfully released version ${{ steps.get_version.outputs.VERSION }}"
          echo "ðŸ“¦ Artifacts:"
          echo "  - JAR file"
          echo "  - Source ZIP"
          echo "  - SHA256 checksums"
          echo "ðŸ”— Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}"
