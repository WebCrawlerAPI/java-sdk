name: Test

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - '**.java'
      - '**.sh'
      - '.github/workflows/test.yml'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - '**.java'
      - '**.sh'
      - '.github/workflows/test.yml'

jobs:
  test:
    name: Test on Java ${{ matrix.java }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: ['8', '11', '17', '21']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Display Java version
        run: java -version

      - name: Run unit tests
        run: |
          cd tests
          chmod +x run-tests.sh
          ./run-tests.sh

      - name: Run integration tests (if API key available)
        if: ${{ secrets.API_KEY != '' }}
        env:
          API_KEY: ${{ secrets.API_KEY }}
          API_BASE_URL: https://api.webcrawlerapi.com
        run: |
          cd tests
          ./run-tests.sh

  compile-examples:
    name: Compile Examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Compile example
        run: |
          cd example/src
          cp ../../WebCrawlerAPI.java .
          javac Example.java WebCrawlerAPI.java
          javac QuickTest.java WebCrawlerAPI.java

      - name: Run QuickTest
        run: |
          cd example/src
          java QuickTest

  verify-sdk:
    name: Verify SDK Standalone
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Verify SDK compiles standalone
        run: |
          mkdir -p /tmp/test-sdk
          cp WebCrawlerAPI.java /tmp/test-sdk/
          cd /tmp/test-sdk
          javac WebCrawlerAPI.java
          echo "✅ SDK compiles successfully as standalone file"

      - name: Verify no external dependencies
        run: |
          cd /tmp/test-sdk
          # Check that only Java standard library is used
          if javap WebCrawlerAPI.class | grep -v "java\." | grep -v "WebCrawlerAPI" | grep "import"; then
            echo "❌ External dependencies found"
            exit 1
          else
            echo "✅ No external dependencies detected"
          fi

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, compile-examples, verify-sdk]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Test Results Summary:"
          echo "===================="
          echo "Tests: ${{ needs.test.result }}"
          echo "Examples: ${{ needs.compile-examples.result }}"
          echo "SDK Verification: ${{ needs.verify-sdk.result }}"

          if [[ "${{ needs.test.result }}" == "success" ]] && \
             [[ "${{ needs.compile-examples.result }}" == "success" ]] && \
             [[ "${{ needs.verify-sdk.result }}" == "success" ]]; then
            echo "✅ All checks passed!"
            exit 0
          else
            echo "❌ Some checks failed"
            exit 1
          fi
